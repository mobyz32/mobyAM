<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AM Machine Calculator</title>
  <style>
    :root{
      --primary:#F89728; --primary-hover:#d97f1f; --text:#111827; --label:#6B7280;
      --panel:#F3F4F6; --page:#FFFFFF; --ring:rgba(248,151,40,.45); --shadow:rgba(248,151,40,.35);
      --border:#E5E7EB;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:420px;margin:48px auto;padding:24px 16px 32px;background:var(--page);color:var(--text);line-height:1.4;user-select:none}
    h2{font-weight:700;font-size:1.8rem;text-align:center;margin-bottom:1.5rem;color:var(--text)}
    .tabs{display:flex;justify-content:center;margin-bottom:2rem;gap:16px;user-select:none}
    .tab{padding:10px 20px;font-weight:600;font-size:1.05rem;border-radius:24px;border:2px solid transparent;cursor:pointer;color:var(--label);transition:all .25s ease;background:#fff;min-width:80px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .tab:hover{color:var(--primary);border-color:var(--primary)}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary);box-shadow:0 6px 14px var(--shadow);cursor:default}
    section{margin-bottom:2rem}
    h3,.collapsible-toggle{font-weight:600;font-size:1.05rem;margin-bottom:1rem;color:var(--text);border-bottom:1px solid var(--border);padding-bottom:.35rem;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center}
    .input-group{display:grid;grid-template-columns:repeat(2,1fr);gap:12px 16px}
    label{display:block;font-weight:600;font-size:.85rem;color:var(--label);margin-bottom:4px}
    input[type="text"]{width:100%;padding:10px 12px;font-size:1rem;border:1.5px solid #D1D5DB;border-radius:8px;transition:border-color .2s ease,box-shadow .2s ease,background .2s ease;background:var(--panel);color:var(--text)}
    input[type="text"]:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 4px var(--ring)}
    button{background:var(--primary);color:#fff;border:none;padding:14px 16px;border-radius:10px;font-weight:700;font-size:1.05rem;cursor:pointer;transition:transform .06s ease,background .2s ease,box-shadow .2s ease;user-select:none;box-shadow:0 8px 18px var(--shadow)}
    button:active{transform:translateY(1px)}
    button:disabled{background:#FCD7AE;cursor:not-allowed;box-shadow:none}
    button:not(:disabled):hover{background:var(--primary-hover);box-shadow:0 10px 22px var(--shadow)}
    .full{width:100%;margin-top:1.2rem}
    #results{padding:18px 20px;font-size:1.05rem;color:var(--text);background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.05);min-height:68px;white-space:pre-wrap;font-family:'Segoe UI Mono',Consolas,monospace;user-select:text;transition:opacity .25s ease}
    #results b{color:var(--primary-hover)}
    .collapsed .arrow{transform:rotate(-90deg)}
    .collapsible-content{overflow:hidden;max-height:0;transition:max-height .3s ease,opacity .3s ease;pointer-events:none;opacity:0;user-select:none}
    .collapsible-content.open{max-height:600px;opacity:1;pointer-events:auto;user-select:auto}
    .arrow{transition:transform .3s ease;font-size:1.1rem;color:var(--label)}
    .subtle{font-size:.82rem;color:var(--label);text-align:center;margin-top:.5rem}
    .row-right{display:flex;justify-content:flex-end;align-items:center;gap:8px;margin-top:6px;margin-bottom:6px}
    .tiny-chip, .tiny-clear{
      font:inherit;font-weight:700;padding:8px 12px;line-height:1;border-radius:999px;background:#fff;color:var(--primary);
      border:2px solid var(--primary);cursor:pointer;user-select:none;transition:background .15s ease,color .15s ease,box-shadow .2s ease,transform .06s ease;box-shadow:0 2px 6px rgba(0,0,0,.05)
    }
    .tiny-chip:hover,.tiny-clear:hover{background:#FFF7EE}
    .tiny-chip:active,.tiny-clear:active{transform:translateY(1px)}
    .tiny-clear{color:#9A5B12;border-color:#E6A355}
  </style>
</head>
<body>

<h2>AM Machine Calculator</h2>

<div class="tabs" role="tablist" aria-label="Select machine">
  <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="panel-J95"  id="tab-J95">J95</div>
  <div class="tab"         role="tab" tabindex="-1" aria-selected="false" aria-controls="panel-J149" id="tab-J149">J149</div>
</div>

<div id="app"></div>

<section aria-live="polite" aria-atomic="true" aria-relevant="additions">
  <div id="results" aria-label="Calculation results"></div>
</section>

<script type="module">
  /******** Firebase ********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXwW14wEzGz5IjetGeWCb0tmU_lkDJqJI",
    authDomain: "mobyam32.firebaseapp.com",
    projectId: "mobyam32",
    storageBucket: "mobyam32.appspot.com",
    messagingSenderId: "453231570263",
    appId: "1:453231570263:web:1e219d402146960c502212"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getFirestore(appFB);
  enableIndexedDbPersistence(db).catch(()=>{});

  /******** Config & State ********/
  const MACHINES = ["J95","J149"];
  const FIELDS = 4;
  const MAX_DIGITS = 6;
  const month = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const results = $("#results");

  const state = {
    current: "J95",
    data: Object.fromEntries(MACHINES.map(m=>[m,{const:Array(FIELDS).fill(""), val:Array(FIELDS).fill(""), lastUpdated:null}]))
  };
  let activeInput = null;

  /******** Utils ********/
  const fmtDate = d => `${String(d.getDate()).padStart(2,"0")} ${month[d.getMonth()]} ${d.getFullYear()}`;
  const setStatus = (m, t)=> { const el = $(`#cloudStatus-${m}`); if (el) el.textContent = t; };
  const bankFormat = raw => {
    let digits = String(raw||"").replace(/\D/g,"");
    if (!digits) return "";
    if (digits.length > MAX_DIGITS) digits = digits.slice(0, MAX_DIGITS);
    return (parseInt(digits,10)/100).toFixed(2);
  };
  const docRef = m => doc(db, "constants", m);
  const lkey   = (m,i)=>`${m}_const${i+1}`;

  const pullLocalConst = m => Array.from({length:FIELDS},(_,i)=>localStorage.getItem(lkey(m,i)) ?? "");
  const pushLocalConst = (m, arr)=> arr.forEach((v,i)=>{ if(v!=="" && !isNaN(parseFloat(v))) localStorage.setItem(lkey(m,i), parseFloat(v).toFixed(2)); });

  /******** Cloud I/O ********/
  async function loadConstants(m){
    try{
      setStatus(m,"Loading from cloud…");
      const snap = await getDoc(docRef(m));
      if (snap.exists()){
        const d = snap.data();
        const arr = state.data[m].const.slice();
        for (let i=0;i<FIELDS;i++){
          const v = d[`c${i+1}`];
          if (typeof v === "number") arr[i] = v.toFixed(2);
        }
        state.data[m].const = arr;
        state.data[m].lastUpdated = d.lastUpdated ? new Date(d.lastUpdated) : new Date();
        pushLocalConst(m, arr);
        setStatus(m, `Updated ${fmtDate(state.data[m].lastUpdated)}`);
      } else { setStatus(m, "No cloud values yet (using local if any)."); }
    }catch(e){ setStatus(m,"Cloud load failed (using local if any)."); console.error(e); }
  }

  async function saveConstants(m){
    const payload = {};
    for (let i=0;i<FIELDS;i++){
      const v = parseFloat(state.data[m].const[i]);
      if (isNaN(v)) { alert("Please fill all constants with valid numbers."); return false; }
      payload[`c${i+1}`] = v;
    }
    try{
      const now = new Date().toISOString();
      await setDoc(docRef(m), { ...payload, lastUpdated: now }, { merge:true });
      return true;
    }catch(e){ console.error(e); return false; }
  }

  async function loadLasers(m){
    try{
      const snap = await getDoc(docRef(m));
      if (snap.exists()){
        const d = snap.data(), vals=[];
        for (let i=0;i<FIELDS;i++){
          const v = d[`l${i+1}`]; vals.push(typeof v==="number" ? v.toFixed(2) : "");
        }
        state.data[m].val = vals;
      }
    }catch(e){ console.error("Load lasers failed", e); }
  }

  async function saveLasersOnce(m){
    const payload = { lasersUpdated: new Date().toISOString() };
    for (let i=0;i<FIELDS;i++){
      const v = parseFloat(state.data[m].val[i]);
      payload[`l${i+1}`] = isNaN(v) ? null : v;
    }
    try{ await setDoc(docRef(m), payload, { merge:true }); }
    catch(e){ console.error("Save lasers failed", e); }
  }

  /******** Render ********/
  function inputBlock(id,label, val=""){
    return `
      <div>
        <label for="${id}">${label}</label>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="${id}" value="${val}" placeholder="${label}"/>
      </div>`;
  }

  function renderMachine(m){
    const c = state.data[m].const, v = state.data[m].val;
    return `
      <div id="panel-${m}" role="tabpanel" aria-labelledby="tab-${m}" ${m===state.current?"":"hidden"}>
        <section aria-labelledby="lasers-${m}">
          <h3 id="lasers-${m}">Enter Laser Values</h3>
          <div class="input-group" id="values-${m}">
            ${Array.from({length:FIELDS},(_,i)=>inputBlock(`val${i+1}-${m}`,`Laser ${i+1}`, v[i]||"")).join("")}
          </div>
          <div class="row-right">
            <button type="button" class="tiny-clear" id="clear-${m}" aria-label="Clear lasers">Clear</button>
            <button type="button" class="tiny-chip"  id="chip00-${m}" aria-label="Append double zero">.00</button>
          </div>
          <button id="calc-${m}" class="full" type="button" ${allLasersValid(m)?"":"disabled"}>Calculate</button>
        </section>

        <section aria-labelledby="const-${m}">
          <div class="collapsible-toggle collapsed" id="constHdr-${m}" tabindex="0" role="button" aria-expanded="false" aria-controls="constBox-${m}">
            Calibration Constants <span class="arrow">▶</span>
          </div>
          <div id="constBox-${m}" class="collapsible-content" role="region" aria-hidden="true">
            <div class="input-group" id="consts-${m}">
              ${Array.from({length:FIELDS},(_,i)=>inputBlock(`const${i+1}-${m}`,`Calibration Constant ${i+1}`, c[i]||"")).join("")}
            </div>
            <button id="save-${m}" class="full" type="button">Save Constants</button>
            <div class="subtle" id="cloudStatus-${m}" aria-live="polite"></div>
          </div>
        </section>
      </div>`;
  }

  function renderAll(){
    $("#app").innerHTML = MACHINES.map(renderMachine).join("");
    syncTabsUI();
  }

  /******** Validation & Calc ********/
  function allLasersValid(m){ return state.data[m].val.every(x=>!isNaN(parseFloat(x))); }

  function recalc(m){
    let out="";
    for (let i=0;i<FIELDS;i++){
      const c=parseFloat(state.data[m].const[i]||"0");
      const v=parseFloat(state.data[m].val[i]||"0");
      out += `${m} Laser ${i+1}: <b>${(v-c).toFixed(2)}</b><br>\n`;
    }
    results.style.opacity=0;
    setTimeout(()=>{ results.innerHTML=out.trim(); results.style.opacity=1; }, 120);
  }

  /******** Tabs ********/
  function activateTab(tabId){
    const m = tabId.replace("tab-","");
    state.current = m;
    $("[role=tabpanel]") && $$("[role=tabpanel]").forEach(p=>p.hidden = (p.id !== `panel-${m}`));
    $$(".tab").forEach(t=>{
      const on = t.id === tabId;
      t.classList.toggle("active", on);
      t.setAttribute("aria-selected", on);
      t.setAttribute("tabindex", on?"0":"-1");
    });
    const url = new URL(location.href); url.searchParams.set("m", m); history.replaceState({}, "", url.toString());
    results.textContent="";
  }
  function syncTabsUI(){
    $$(".tab").forEach(t=>{
      const on = t.id === `tab-${state.current}`;
      t.classList.toggle("active", on);
      t.setAttribute("aria-selected", on);
      t.setAttribute("tabindex", on?"0":"-1");
    });
  }

  /******** Events ********/
  document.addEventListener("focusin", (e)=>{
    if (e.target.tagName==="INPUT") activeInput = e.target;
  });

  document.addEventListener("beforeinput", (e)=>{
    const el = e.target;
    if (el.tagName!=="INPUT") return;
    if (e.inputType==="insertText" && /\d/.test(e.data)){
      const digits = (el.value||"").replace(/\D/g,"");
      const selectionRoom = el.selectionStart !== el.selectionEnd ? 0 : 1;
      if (digits.length + selectionRoom > MAX_DIGITS) e.preventDefault();
    }
  });

  document.addEventListener("input", (e)=>{
    const el = e.target;
    if (el.tagName!=="INPUT") return;
    const id = el.id;
    if (!/^(val|const)\d+-(J95|J149)$/.test(id)) return;

    el.value = bankFormat(el.value);
    const [,kind, idxStr, mach] = id.match(/^(val|const)(\d+)-(J95|J149)$/);
    const i = parseInt(idxStr,10)-1;

    if (kind==="val"){
      state.data[mach].val[i] = el.value;
      const btn = $(`#calc-${mach}`); btn && (btn.disabled = !allLasersValid(mach));
      el.style.borderColor = isNaN(parseFloat(el.value)) ? "#ef4444" : "#D1D5DB";
    } else {
      state.data[mach].const[i] = el.value;
    }
  });

  document.addEventListener("click", async (e)=>{
    const t = e.target;

    if (t.classList.contains("tab")) return activateTab(t.id);

    if (t.id.startsWith("constHdr-") || t.closest(".collapsible-toggle")){
      const hdr = t.id ? t : t.closest(".collapsible-toggle");
      const m = hdr.id.replace("constHdr-","");
      const box = $(`#constBox-${m}`), arrow = hdr.querySelector(".arrow");
      const expanded = hdr.getAttribute("aria-expanded")==="true";
      hdr.setAttribute("aria-expanded", String(!expanded));
      box.classList.toggle("open"); hdr.classList.toggle("collapsed");
      arrow.textContent = expanded ? "▶" : "▼";
      return;
    }

    // Clear lasers
    if (t.id.startsWith("clear-")){
      const m = t.id.replace("clear-","");
      for (let i=0;i<FIELDS;i++){
        state.data[m].val[i] = "";
        const el = $(`#val${i+1}-${m}`);
        if (el){ el.value=""; el.style.borderColor="#D1D5DB"; }
      }
      const btn = $(`#calc-${m}`); btn && (btn.disabled = true);
      // keep focus on first field after clear (optional)
      const first = $(`#val1-${m}`); if (first){ first.focus(); activeInput = first; }
      return;
    }

    // .00 pill: append 00 and move focus to NEXT laser (stay on last)
    if (t.id.startsWith("chip00-")){
      const m = t.id.replace("chip00-","");
      let target = activeInput;
      const panel = $(`#panel-${m}`);
      const isLaserHere = target && panel.contains(target) && /^val\d+-/.test(target.id);
      if (!isLaserHere){ target = $(`#val1-${m}`); if (!target) return; activeInput = target; }

      let digits = String(target.value||"").replace(/\D/g,"");
      digits = (digits + "00").slice(0, MAX_DIGITS);
      target.value = bankFormat(digits);

      const curIdx = parseInt(target.id.match(/^val(\d+)-/)[1],10)-1;
      state.data[m].val[curIdx] = target.value;
      const btn = $(`#calc-${m}`); btn && (btn.disabled = !allLasersValid(m));

      // move focus to next laser if not the last
      if (curIdx < FIELDS - 1){
        const next = $(`#val${curIdx+2}-${m}`);
        if (next){ next.focus(); activeInput = next; }
      }
      return;
    }

    if (t.id.startsWith("save-")){
      const m = t.id.replace("save-","");
      for (let i=0;i<FIELDS;i++){
        const el = $(`#const${i+1}-${m}`);
        el.value = bankFormat(el.value);
        state.data[m].const[i] = el.value;
      }
      // optimistic UI
      const now = new Date(); state.data[m].lastUpdated = now;
      setStatus(m, `Updated ${fmtDate(now)}`); t.textContent="Saved ✓"; setTimeout(()=> t.textContent="Save Constants",1500);
      // background save + local mirror
      const ok = await saveConstants(m);
      if (!ok) setStatus(m, "Cloud save failed (saved locally).");
      else     pushLocalConst(m, state.data[m].const);
      return;
    }

    if (t.id.startsWith("calc-")){
      const m = t.id.replace("calc-","");
      recalc(m);
      await saveLasersOnce(m); // sticky lasers only when Calculate
      return;
    }
  });

  document.addEventListener("keydown",(e)=>{
    if (!["ArrowLeft","ArrowRight"].includes(e.key)) return;
    const tabs = $$(".tab"); const idx = tabs.indexOf(document.activeElement);
    if (idx===-1) return;
    e.preventDefault();
    const next = e.key==="ArrowRight" ? (idx+1)%tabs.length : (idx-1+tabs.length)%tabs.length;
    tabs[next].focus(); activateTab(tabs[next].id);
  });

  /******** Init ********/
  async function init(){
    // quick paint from local constants
    MACHINES.forEach(m=> state.data[m].const = pullLocalConst(m));
    await Promise.all(MACHINES.flatMap(m=>[loadConstants(m), loadLasers(m)]));
    $("#app").innerHTML = MACHINES.map(renderMachine).join("");

    // Deep link ?m=
    const urlM = (new URLSearchParams(location.search).get("m")||"J95").toUpperCase();
    state.current = MACHINES.includes(urlM) ? urlM : "J95";
    activateTab(`tab-${state.current}`);
  }
  init();
</script>
</body>
</html>
