<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AM Machine Calculator</title>
  <style>
    :root{
      --primary:#F89728; --primary-hover:#d97f1f; --text:#111827; --label:#6B7280;
      --panel:#F3F4F6; --page:#FFFFFF; --ring:rgba(248,151,40,.45); --shadow:rgba(248,151,40,.35);
      --border:#E5E7EB;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width:420px; margin:48px auto; padding:24px 16px 32px;
      background:var(--page); color:var(--text); line-height:1.4; user-select:none;
    }
    h2{ font-weight:700; font-size:1.8rem; text-align:center; margin-bottom:1.5rem; color:var(--text); }
    .tabs{ display:flex; justify-content:center; margin-bottom:2rem; gap:16px; user-select:none; }
    .tab{
      padding:10px 20px; font-weight:600; font-size:1.05rem; border-radius:24px; border:2px solid transparent; cursor:pointer;
      color:var(--label); transition:all .25s ease; background:#fff; min-width:80px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .tab:hover{ color:var(--primary); border-color:var(--primary); }
    .tab.active{ color:#fff; background:var(--primary); border-color:var(--primary); box-shadow:0 6px 14px var(--shadow); cursor:default; }
    section{ margin-bottom:2rem; }
    h3,.collapsible-toggle{
      font-weight:600; font-size:1.05rem; margin-bottom:1rem; color:var(--text);
      border-bottom:1px solid var(--border); padding-bottom:.35rem; cursor:pointer;
      user-select:none; display:flex; justify-content:space-between; align-items:center;
    }
    .input-group{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px 16px; }
    label{ display:block; font-weight:600; font-size:.85rem; color:var(--label); margin-bottom:4px; }
    input[type="text"]{
      width:100%; padding:10px 12px; font-size:1rem; border:1.5px solid #D1D5DB; border-radius:8px;
      transition:border-color .2s ease, box-shadow .2s ease, background .2s ease; background:var(--panel); color:var(--text);
    }
    input[type="text"]:focus{ outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px var(--ring); }
    button{
      width:100%; background:var(--primary); color:#fff; border:none; padding:14px 0; border-radius:10px;
      font-weight:700; font-size:1.05rem; cursor:pointer; transition:transform .06s ease, background .2s ease, box-shadow .2s ease;
      user-select:none; margin-top:1.2rem; box-shadow:0 8px 18px var(--shadow);
    }
    button:active{ transform:translateY(1px); }
    button:disabled{ background:#FCD7AE; cursor:not-allowed; box-shadow:none; }
    button:not(:disabled):hover{ background:var(--primary-hover); box-shadow:0 10px 22px var(--shadow); }
    #results{
      padding:18px 20px; font-size:1.05rem; color:var(--text); background:#fff; border:1px solid var(--border);
      border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,.05); min-height:68px; white-space:pre-wrap;
      font-family:'Segoe UI Mono', Consolas, monospace; user-select:text; transition:opacity .25s ease;
    }
    #results b{ color:var(--primary-hover); }
    .collapsed .arrow{ transform:rotate(-90deg); }
    .collapsible-content{ overflow:hidden; max-height:0; transition:max-height .3s ease, opacity .3s ease; pointer-events:none; opacity:0; user-select:none; }
    .collapsible-content.open{ max-height:600px; opacity:1; pointer-events:auto; user-select:auto; }
    .arrow{ transition:transform .3s ease; font-size:1.1rem; color:var(--label); }
    .subtle{ font-size:.82rem; color:var(--label); text-align:center; margin-top:.5rem; }

    /* tiny pill .00 button row (right aligned) */
    .row-right{ display:flex; justify-content:flex-end; align-items:center; margin-top:6px; margin-bottom:6px; }
    .tiny-chip{
      font: inherit; font-weight:700; padding:6px 10px; line-height:1; border-radius:999px;
      background:#fff; color:var(--primary); border:2px solid var(--primary);
      cursor:pointer; user-select:none; transition:background .15s ease, color .15s ease, box-shadow .2s ease, transform .06s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .tiny-chip:hover{ background:#FFF7EE; }
    .tiny-chip:active{ transform: translateY(1px); }
  </style>
</head>
<body>

<h2>AM Machine Calculator</h2>

<div class="tabs" role="tablist" aria-label="Select machine">
  <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="machine-J95" id="tab-J95">J95</div>
  <div class="tab" role="tab" tabindex="-1" aria-selected="false" aria-controls="machine-J149" id="tab-J149">J149</div>
</div>

<!-- J95 -->
<div id="machine-J95" role="tabpanel" aria-labelledby="tab-J95">
  <section aria-labelledby="lasers-header-J95">
    <h3 id="lasers-header-J95">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J95" role="group" aria-label="Laser input fields for J95"></div>

    <div class="row-right">
      <button type="button" class="tiny-chip" id="chip00-J95" aria-label="Append double zero to current laser field">.00</button>
    </div>

    <button id="calcBtn-J95" type="button" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J95">
    <div class="collapsible-toggle collapsed" id="calibration-header-J95" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J95">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J95" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J95" role="group" aria-label="Calibration constants input fields for J95"></div>
      <button id="saveBtn-J95" type="button">Save Constants</button>
      <div class="subtle" id="cloudStatus-J95" aria-live="polite"></div>
    </div>
  </section>
</div>

<!-- J149 -->
<div id="machine-J149" role="tabpanel" aria-labelledby="tab-J149" hidden>
  <section aria-labelledby="lasers-header-J149">
    <h3 id="lasers-header-J149">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J149" role="group" aria-label="Laser input fields for J149"></div>

    <div class="row-right">
      <button type="button" class="tiny-chip" id="chip00-J149" aria-label="Append double zero to current laser field">.00</button>
    </div>

    <button id="calcBtn-J149" type="button" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J149">
    <div class="collapsible-toggle collapsed" id="calibration-header-J149" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J149">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J149" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J149" role="group" aria-label="Calibration constants input fields for J149"></div>
      <button id="saveBtn-J149" type="button">Save Constants</button>
      <div class="subtle" id="cloudStatus-J149" aria-live="polite"></div>
    </div>
  </section>
</div>

<section aria-live="polite" aria-atomic="true" aria-relevant="additions">
  <div id="results" aria-label="Calculation results"></div>
</section>

<!-- Firebase + App (module) -->
<script type="module">
  /************ DATA LAYER (Firestore + Local) ************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXwW14wEzGz5IjetGeWCb0tmU_lkDJqJI",
    authDomain: "mobyam32.firebaseapp.com",
    projectId: "mobyam32",
    storageBucket: "mobyam32.appspot.com",
    messagingSenderId: "453231570263",
    appId: "1:453231570263:web:1e219d402146960c502212"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // Offline persistence (best effort)
  enableIndexedDbPersistence(db).catch(() => { /* fine if not available */ });

  /************ CONFIG / STATE ************/
  const CONFIG = {
    MACHINES: ['J95','J149'],
    NUM_FIELDS: 4,
    MAX_DIGITS: 6 // -> 9999.99 cap
  };

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const $ = (sel, root=document) => root.querySelector(sel);
  const results = $('#results');

  // App state: constants + sticky laser values + lastUpdated
  const state = {
    currentMachine: 'J95',
    machines: {
      J95:  { const: Array(CONFIG.NUM_FIELDS).fill(''), val: Array(CONFIG.NUM_FIELDS).fill(''), lastUpdated: null },
      J149: { const: Array(CONFIG.NUM_FIELDS).fill(''), val: Array(CONFIG.NUM_FIELDS).fill(''), lastUpdated: null }
    }
  };

  /************ UTILITIES ************/
  const formatDate = (d) => `${String(d.getDate()).padStart(2,'0')} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
  const setStatus = (machine, text) => { const el = $(`#cloudStatus-${machine}`); if (el) el.textContent = text; };
  const debounce = (fn, ms=80) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

  // Bank formatter pipeline: digits → cap → /100 → fixed(2)
  function bankFormat(raw, maxDigits){
    let digits = String(raw||'').replace(/\D/g,'');
    if (!digits) return '';
    if (digits.length > maxDigits) digits = digits.slice(0, maxDigits);
    return (parseInt(digits,10)/100).toFixed(2);
  }

  function machineDocRef(machine){ return doc(db, "constants", machine); }
  function localKeyConst(machine, i){ return `${machine}_const${i+1}`; }
  function localKeyVal(machine, i){ return `${machine}_val${i+1}`; }  // <-- sticky lasers

  // Local storage sync for constants
  function pullLocalConstants(machine){
    const arr = [];
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const v = localStorage.getItem(localKeyConst(machine, i));
      arr.push(v ?? '');
    }
    return arr;
  }
  function pushLocalConstants(machine, constArr){
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const v = constArr[i];
      if (v !== '' && !isNaN(parseFloat(v))) {
        localStorage.setItem(localKeyConst(machine, i), parseFloat(v).toFixed(2));
      }
    }
  }

  // Sticky lasers: pull/push last-used values per machine
  function pullLocalLasers(machine){
    const arr = [];
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const v = localStorage.getItem(localKeyVal(machine, i));
      arr.push(v ?? '');
    }
    return arr;
  }
  function pushLocalLaser(machine, i, value){
    if (value !== '' && !isNaN(parseFloat(value))) {
      localStorage.setItem(localKeyVal(machine, i), parseFloat(value).toFixed(2));
    }
  }

  // Cloud load/save
  async function loadCloud(machine){
    try{
      setStatus(machine, 'Loading from cloud…');
      const snap = await getDoc(machineDocRef(machine));
      if (snap.exists()){
        const data = snap.data();
        const newConsts = state.machines[machine].const.slice();
        for (let i=0;i<CONFIG.NUM_FIELDS;i++){
          const v = data[`c${i+1}`];
          if (typeof v === 'number') newConsts[i] = v.toFixed(2);
        }
        state.machines[machine].const = newConsts;
        state.machines[machine].lastUpdated = data.lastUpdated ? new Date(data.lastUpdated) : new Date();
        pushLocalConstants(machine, newConsts);
        setStatus(machine, `Updated ${formatDate(state.machines[machine].lastUpdated)}`);
      } else {
        setStatus(machine, 'No cloud values yet (using local if any).');
      }
    }catch(e){
      setStatus(machine, 'Cloud load failed (using local if any).');
      console.error(e);
    }
  }

  async function saveCloud(machine){
    // Only save if all constants are valid numbers
    const constants = {};
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const v = parseFloat(state.machines[machine].const[i]);
      if (isNaN(v)) { alert('Please fill all constants with valid numbers.'); return false; }
      constants[`c${i+1}`] = v;
    }
    try{
      const nowIso = new Date().toISOString();
      await setDoc(machineDocRef(machine), { ...constants, lastUpdated: nowIso }, { merge:true });
      // success: nothing else to do; UI already optimistically updated
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }

  /************ UI (Render + Events) ************/
  function renderInputs(machine){
    // constants
    const constWrap = $(`#constInputs-${machine}`);
    const constParts = [];
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      constParts.push(`
        <div>
          <label for="const${i+1}-${machine}">Calibration Constant ${i+1}</label>
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 id="const${i+1}-${machine}" value="${state.machines[machine].const[i]||''}" placeholder="Calibration Constant ${i+1}" />
        </div>`);
    }
    constWrap.innerHTML = constParts.join('');

    // lasers (sticky auto-fill)
    const valWrap = $(`#valueInputs-${machine}`);
    const valParts = [];
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      valParts.push(`
        <div>
          <label for="val${i+1}-${machine}">Laser ${i+1}</label>
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 id="val${i+1}-${machine}" value="${state.machines[machine].val[i]||''}" placeholder="Laser ${i+1}" />
        </div>`);
    }
    valWrap.innerHTML = valParts.join('');

    // buttons
    const calcBtn = $(`#calcBtn-${machine}`);
    calcBtn.disabled = !allLasersValid(machine);
  }

  // Event delegation for inputs (constants + lasers)
  function attachInputHandlers(machine){
    const constWrap = $(`#constInputs-${machine}`);
    const valWrap  = $(`#valueInputs-${machine}`);
    const debouncedCheck = debounce(()=> updateCalcButton(machine), 80);

    const beforeInputGuard = (e)=>{
      // prevent exceeding MAX_DIGITS for numeric insert
      if (e.inputType === 'insertText' && /\d/.test(e.data)) {
        const current = e.target.value || '';
        const digits = current.replace(/\D/g,'');
        const selection = e.target.selectionStart !== e.target.selectionEnd ? 0 : 1;
        if (digits.length + selection > CONFIG.MAX_DIGITS) e.preventDefault();
      }
    };

    const onConstInput = (e)=>{
      if (!e.target.id.startsWith('const')) return;
      const idx = parseInt(e.target.id.match(/^const(\d+)-/)[1],10)-1;
      const formatted = bankFormat(e.target.value, CONFIG.MAX_DIGITS);
      e.target.value = formatted;
      state.machines[machine].const[idx] = formatted;
    };

    const onValInput = (e)=>{
      if (!e.target.id.startsWith('val')) return;
      const idx = parseInt(e.target.id.match(/^val(\d+)-/)[1],10)-1;
      const formatted = bankFormat(e.target.value, CONFIG.MAX_DIGITS);
      e.target.value = formatted;
      state.machines[machine].val[idx] = formatted;

      // STICKY: persist last-used laser value immediately
      pushLocalLaser(machine, idx, formatted);

      debouncedCheck();
    };

    const onFocusSelectAll = (e)=>{
      if (e.target.tagName === 'INPUT') setTimeout(()=> e.target.select(),0);
    };

    constWrap.addEventListener('beforeinput', beforeInputGuard);
    valWrap .addEventListener('beforeinput', beforeInputGuard);
    constWrap.addEventListener('input', onConstInput);
    valWrap .addEventListener('input', onValInput);
    constWrap.addEventListener('focus', onFocusSelectAll, true);
    valWrap .addEventListener('focus', onFocusSelectAll, true);
  }

  function allLasersValid(machine){
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      if (isNaN(parseFloat(state.machines[machine].val[i]))) return false;
    }
    return true;
  }
  function updateCalcButton(machine){
    const ok = allLasersValid(machine);
    const btn = $(`#calcBtn-${machine}`);
    btn.disabled = !ok;
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const el = $(`#val${i+1}-${machine}`);
      if (!el) continue;
      const v = parseFloat(el.value);
      el.style.borderColor = isNaN(v) ? '#ef4444' : '#D1D5DB';
    }
  }

  function calculate(machine){
    let out = '';
    for (let i=0;i<CONFIG.NUM_FIELDS;i++){
      const c = parseFloat(state.machines[machine].const[i] || '0');
      const v = parseFloat(state.machines[machine].val[i]   || '0');
      out += `${machine} Laser ${i+1}: <b>${(v - c).toFixed(2)}</b><br>\n`;
    }
    results.style.opacity=0;
    setTimeout(()=>{ results.innerHTML = out.trim(); results.style.opacity=1; }, 120);
  }

  function setupCalcButtons(machine){
    $(`#calcBtn-${machine}`).addEventListener('click', ()=> calculate(machine));
  }

  function setupCollapsible(machine){
    const header = $(`#calibration-header-${machine}`);
    const panel  = $(`#constContent-${machine}`);
    const arrow  = header.querySelector('.arrow');
    const toggle = ()=>{
      const expanded = header.getAttribute('aria-expanded')==='true';
      header.setAttribute('aria-expanded', String(!expanded));
      panel.classList.toggle('open');
      header.classList.toggle('collapsed');
      arrow.textContent = expanded ? '▶' : '▼';
    };
    header.addEventListener('click', toggle);
    header.addEventListener('keydown', e=>{
      if (e.key==='Enter' || e.key===' ') { e.preventDefault(); toggle(); }
    });
  }

  function setupTabs(){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click', ()=> activateTab(tab.id));
      tab.addEventListener('keydown', e=>{
        if (e.key==='ArrowRight' || e.key==='ArrowLeft'){
          e.preventDefault();
          const arr=[...tabs]; let idx = arr.indexOf(document.activeElement);
          idx = (e.key==='ArrowRight') ? (idx+1)%arr.length : (idx-1+arr.length)%arr.length;
          arr[idx].focus(); activateTab(arr[idx].id);
        }
      });
    });
  }

  function activateTab(tabId){
    document.querySelectorAll('.tab').forEach(tab=>{
      const active = (tab.id === tabId);
      tab.classList.toggle('active', active);
      tab.setAttribute('aria-selected', active);
      tab.setAttribute('tabindex', active ? '0' : '-1');
      const panel = document.getElementById(tab.getAttribute('aria-controls'));
      if (panel) panel.hidden = !active;
    });
    const m = tabId.replace('tab-','');
    state.currentMachine = m;

    // keep URL in sync (QR/bookmark)
    const url = new URL(window.location.href);
    url.searchParams.set('m', m);
    history.replaceState({}, '', url.toString());

    results.textContent = '';
  }

  // .00 pill: append two zeros to current laser (or Laser 1) for that machine
  function appendDoubleZero(machine){
    let target = document.activeElement;
    const panel = document.getElementById(`machine-${machine}`);
    const onLaserHere = target && panel.contains(target) && /^val\d+-/.test(target.id);
    if (!onLaserHere) target = document.getElementById(`val1-${machine}`);
    if (!target) return;

    let digits = String(target.value||'').replace(/\D/g,'');
    digits = (digits + '00').slice(0, CONFIG.MAX_DIGITS); // respect cap
    const formatted = bankFormat(digits, CONFIG.MAX_DIGITS);

    target.value = formatted;
    const idx = parseInt(target.id.match(/^val(\d+)-/)[1],10) - 1;
    state.machines[machine].val[idx] = formatted;
    pushLocalLaser(machine, idx, formatted); // keep sticky in sync
    updateCalcButton(machine);
  }

  function setupChipButtons(){
    document.getElementById('chip00-J95') .addEventListener('click', ()=> appendDoubleZero('J95'));
    document.getElementById('chip00-J149').addEventListener('click', ()=> appendDoubleZero('J149'));
  }

  function getMachineFromUrl(){
    const m = (new URLSearchParams(window.location.search).get('m') || '').toUpperCase();
    return CONFIG.MACHINES.includes(m) ? m : null;
  }

  function setupSaveButtons(machine){
    $(`#saveBtn-${machine}`).addEventListener('click', ()=>{
      // Normalize constants to local & state first
      for (let i=0;i<CONFIG.NUM_FIELDS;i++){
        const el = document.getElementById(`const${i+1}-${machine}`);
        const formatted = bankFormat(el.value, CONFIG.MAX_DIGITS);
        el.value = formatted;
        state.machines[machine].const[i] = formatted;
      }
      pushLocalConstants(machine, state.machines[machine].const);

      // OPTIMISTIC UI: show updated now
      const now = new Date();
      state.machines[machine].lastUpdated = now;
      setStatus(machine, `Updated ${formatDate(now)}`);
      const btn = $(`#saveBtn-${machine}`);
      btn.textContent = 'Saved ✓';
      setTimeout(()=> btn.textContent='Save Constants', 1500);

      // Then sync to Firestore in the background
      saveCloud(machine).then(ok=>{
        if (!ok) setStatus(machine, 'Cloud save failed (saved locally).');
      });
    });
  }

  /************ INIT ************/
  async function init(){
    // Seed state from local first (fast UI), including STICKY lasers
    for (const machine of CONFIG.MACHINES){
      state.machines[machine].const = pullLocalConstants(machine);
      state.machines[machine].val   = pullLocalLasers(machine);   // <-- sticky values loaded
      renderInputs(machine);
      attachInputHandlers(machine);
      setupCalcButtons(machine);
      setupCollapsible(machine);
      setupSaveButtons(machine);

      // Cloud refresh constants; re-render when ready
      loadCloud(machine).then(()=> renderInputs(machine));
    }
    setupTabs();
    setupChipButtons();

    // Deep link to machine via ?m=
    const urlMachine = getMachineFromUrl() || 'J95';
    activateTab('tab-' + urlMachine);
  }

  init();
</script>

</body>
</html>
