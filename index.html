<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AM Machine Calculator</title>
  <style>
    :root{
      --primary:#F89728; --primary-hover:#d97f1f; --text:#111827; --label:#6B7280;
      --panel:#F3F4F6; --page:#FFFFFF; --ring:rgba(248,151,40,.45); --shadow:rgba(248,151,40,.35);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width:420px; margin:48px auto; padding:24px 16px 32px;
      background:var(--page); color:var(--text); line-height:1.4; user-select:none;
    }
    h2{ font-weight:700; font-size:1.8rem; text-align:center; margin-bottom:1.5rem; color:var(--text); }
    .tabs{ display:flex; justify-content:center; margin-bottom:2rem; gap:16px; user-select:none; }
    .tab{
      padding:10px 20px; font-weight:600; font-size:1.05rem; border-radius:24px; border:2px solid transparent; cursor:pointer;
      color:var(--label); transition:all .25s ease; background:#fff; min-width:80px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .tab:hover{ color:var(--primary); border-color:var(--primary); }
    .tab.active{ color:#fff; background:var(--primary); border-color:var(--primary); box-shadow:0 6px 14px var(--shadow); cursor:default; }
    section{ margin-bottom:2rem; }
    h3,.collapsible-toggle{
      font-weight:600; font-size:1.05rem; margin-bottom:1rem; color:var(--text);
      border-bottom:1px solid #E5E7EB; padding-bottom:.35rem; cursor:pointer;
      user-select:none; display:flex; justify-content:space-between; align-items:center;
    }
    .input-group{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px 16px; }
    label{ display:block; font-weight:600; font-size:.85rem; color:var(--label); margin-bottom:4px; }
    input[type="text"]{
      width:100%; padding:10px 12px; font-size:1rem; border:1.5px solid #D1D5DB; border-radius:8px;
      transition:border-color .2s ease, box-shadow .2s ease, background .2s ease; background:var(--panel); color:var(--text);
    }
    input[type="text"]:focus{ outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px var(--ring); }
    button{
      width:100%; background:var(--primary); color:#fff; border:none; padding:14px 0; border-radius:10px;
      font-weight:700; font-size:1.05rem; cursor:pointer; transition:transform .06s ease, background .2s ease, box-shadow .2s ease;
      user-select:none; margin-top:1.2rem; box-shadow:0 8px 18px var(--shadow);
    }
    button:active{ transform:translateY(1px); }
    button:disabled{ background:#FCD7AE; cursor:not-allowed; box-shadow:none; }
    button:not(:disabled):hover{ background:var(--primary-hover); box-shadow:0 10px 22px var(--shadow); }
    #results{
      padding:18px 20px; font-size:1.05rem; color:var(--text); background:#fff; border:1px solid #E5E7EB;
      border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,.05); min-height:68px; white-space:pre-wrap;
      font-family:'Segoe UI Mono', Consolas, monospace; user-select:text; transition:opacity .25s ease;
    }
    #results b{ color:var(--primary-hover); }
    .collapsed .arrow{ transform:rotate(-90deg); }
    .collapsible-content{ overflow:hidden; max-height:0; transition:max-height .3s ease, opacity .3s ease; pointer-events:none; opacity:0; user-select:none; }
    .collapsible-content.open{ max-height:600px; opacity:1; pointer-events:auto; user-select:auto; }
    .arrow{ transition:transform .3s ease; font-size:1.1rem; color:var(--label); }
    .subtle{ font-size:.82rem; color:var(--label); text-align:center; margin-top:.5rem; }
  </style>
</head>
<body>

<h2>AM Machine Calculator</h2>

<div class="tabs" role="tablist" aria-label="Select machine">
  <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="machine-J95" id="tab-J95">J95</div>
  <div class="tab" role="tab" tabindex="-1" aria-selected="false" aria-controls="machine-J149" id="tab-J149">J149</div>
</div>

<!-- J95 -->
<div id="machine-J95" role="tabpanel" aria-labelledby="tab-J95">
  <section aria-labelledby="lasers-header-J95">
    <h3 id="lasers-header-J95">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J95" role="group" aria-label="Laser input fields for J95"></div>
    <button id="calcBtn-J95" type="button" onclick="calculate('J95')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J95">
    <div class="collapsible-toggle collapsed" id="calibration-header-J95" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J95">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J95" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J95" role="group" aria-label="Calibration constants input fields for J95"></div>
      <button id="saveBtn-J95" type="button" onclick="saveConstants('J95')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J95" aria-live="polite"></div>
    </div>
  </section>
</div>

<!-- J149 -->
<div id="machine-J149" role="tabpanel" aria-labelledby="tab-J149" hidden>
  <section aria-labelledby="lasers-header-J149">
    <h3 id="lasers-header-J149">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J149" role="group" aria-label="Laser input fields for J149"></div>
    <button id="calcBtn-J149" type="button" onclick="calculate('J149')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J149">
    <div class="collapsible-toggle collapsed" id="calibration-header-J149" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J149">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J149" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J149" role="group" aria-label="Calibration constants input fields for J149"></div>
      <button id="saveBtn-J149" type="button" onclick="saveConstants('J149')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J149" aria-live="polite"></div>
    </div>
  </section>
</div>

<section aria-live="polite" aria-atomic="true" aria-relevant="additions">
  <div id="results" aria-label="Calculation results"></div>
</section>

<!-- Firebase + App (module) -->
<script type="module">
  /***** FIREBASE SETUP *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXwW14wEzGz5IjetGeWCb0tmU_lkDJqJI",
    authDomain: "mobyam32.firebaseapp.com",
    projectId: "mobyam32",
    storageBucket: "mobyam32.appspot.com",
    messagingSenderId: "453231570263",
    appId: "1:453231570263:web:1e219d402146960c502212"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /***** CONFIG / HELPERS *****/
  const MACHINES = ['J95','J149'];
  const NUM_FIELDS = 4;
  const MAX_DIGITS = 6; // -> 9999.99 max
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const $ = (sel, root=document) => root.querySelector(sel);

  const results = $('#results');

  const formatDate = (d) =>
    `${String(d.getDate()).padStart(2,'0')} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;

  const setStatus = (machine, text) => {
    const el = $(`#cloudStatus-${machine}`);
    if (el) el.textContent = text;
  };

  // Bank-style formatter with max-digit cap
  function attachBankFormatter(inputEl, maxDigits = MAX_DIGITS){
    // prevent exceeding cap on type (not required, but nicer UX)
    inputEl.addEventListener('beforeinput', (e) => {
      if (e.inputType === 'insertText' && /\d/.test(e.data)) {
        const digits = (inputEl.value || '').replace(/\D/g, '');
        const selection = inputEl.selectionStart !== inputEl.selectionEnd ? 0 : 1; // allow replacing selection
        if (digits.length + selection > maxDigits) e.preventDefault();
      }
    });
    inputEl.addEventListener('input', () => {
      let digits = (inputEl.value || '').replace(/\D/g,'');
      if (!digits) { inputEl.value = ''; return; }
      if (digits.length > maxDigits) digits = digits.slice(0, maxDigits);
      inputEl.value = (parseInt(digits,10) / 100).toFixed(2);
    });
    inputEl.addEventListener('focus', () => setTimeout(() => inputEl.select(), 0));
  }

  function getMachineFromUrl(){
    const m = (new URLSearchParams(window.location.search).get('m') || '').toUpperCase();
    return MACHINES.includes(m) ? m : null;
  }

  // Renders inputs and attaches formatter
  function renderInputs(containerId, prefix, labelPrefix, loadSaved, machine){
    const container = document.getElementById(containerId);
    const parts = [];
    for(let i=1;i<=NUM_FIELDS;i++){
      const saved = loadSaved && prefix==='const'
        ? (localStorage.getItem(`${machine}_const${i}`) || '')
        : '';
      parts.push(`
        <div>
          <label for="${prefix}${i}-${machine}">${labelPrefix} ${i}</label>
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 id="${prefix}${i}-${machine}" placeholder="${labelPrefix} ${i}" value="${saved}" />
        </div>`);
    }
    container.innerHTML = parts.join('');
    for(let i=1;i<=NUM_FIELDS;i++){
      attachBankFormatter(document.getElementById(`${prefix}${i}-${machine}`), MAX_DIGITS);
    }
  }

  async function saveConstants(machine){
    let valid = true;
    const docRef = doc(db, "constants", machine);
    const constants = {};
    for(let i=1;i<=NUM_FIELDS;i++){
      const el = document.getElementById(`const${i}-${machine}`);
      const val = parseFloat(el.value);
      if (isNaN(val)) { valid=false; el.style.borderColor='#ef4444'; }
      else {
        el.style.borderColor='#D1D5DB';
        localStorage.setItem(`${machine}_const${i}`, val.toFixed(2));
        constants[`c${i}`] = val;
      }
    }
    if(!valid){ alert('Please fill all constants with valid numbers.'); return; }

    try{
      setStatus(machine, 'Saving to cloud…');
      const nowIso = new Date().toISOString();
      await setDoc(docRef, { ...constants, lastUpdated: nowIso }, { merge:true });
      setStatus(machine, `Updated ${formatDate(new Date(nowIso))}`);
    }catch(e){
      setStatus(machine, 'Cloud save failed (using local values).'); console.error(e);
    }

    const btn = document.getElementById(`saveBtn-${machine}`);
    btn.textContent = 'Saved ✓';
    setTimeout(() => btn.textContent = 'Save Constants', 1500);
    checkCalculateButton(machine);
  }

  async function loadConstants(machine){
    const docRef = doc(db, "constants", machine);
    try{
      setStatus(machine, 'Loading from cloud…');
      const snap = await getDoc(docRef);
      if (snap.exists()){
        const data = snap.data();
        for(let i=1;i<=NUM_FIELDS;i++){
          const v = data[`c${i}`];
          if (typeof v === 'number') localStorage.setItem(`${machine}_const${i}`, v.toFixed(2));
        }
        const stamp = data.lastUpdated ? new Date(data.lastUpdated) : new Date();
        setStatus(machine, `Updated ${formatDate(stamp)}`);
      } else {
        setStatus(machine, 'No cloud values yet (using local if any).');
      }
    }catch(e){
      setStatus(machine, 'Cloud load failed (using local if any).'); console.error(e);
    }
    // Re-render constants with (possibly) updated local values
    renderInputs(`constInputs-${machine}`, 'const', 'Calibration Constant', true, machine);
  }

  function checkCalculateButton(machine){
    let ok = true;
    for(let i=1;i<=NUM_FIELDS;i++){
      const v = parseFloat(($(`#val${i}-${machine}`)?.value)||'');
      if (isNaN(v)) { ok=false; $(`#val${i}-${machine}`).style.borderColor='#ef4444'; }
      else { $(`#val${i}-${machine}`).style.borderColor='#D1D5DB'; }
    }
    $(`#calcBtn-${machine}`).disabled = !ok;
  }

  function calculate(machine){
    let out = '';
    for(let i=1;i<=NUM_FIELDS;i++){
      const c = parseFloat(localStorage.getItem(`${machine}_const${i}`) || '0');
      const v = parseFloat(($(`#val${i}-${machine}`)?.value) || '0');
      out += `${machine} Laser ${i}: <b>${(v - c).toFixed(2)}</b><br>\n`;
    }
    results.style.opacity=0;
    setTimeout(()=>{ results.innerHTML = out.trim(); results.style.opacity=1; }, 150);
  }

  function setupCollapsible(machine){
    const header = document.getElementById(`calibration-header-${machine}`);
    const panel  = document.getElementById(`constContent-${machine}`);
    const arrow  = header.querySelector('.arrow');
    const toggle = () => {
      const expanded = header.getAttribute('aria-expanded') === 'true';
      header.setAttribute('aria-expanded', String(!expanded));
      panel.classList.toggle('open');
      header.classList.toggle('collapsed');
      arrow.textContent = expanded ? '▶' : '▼';
    };
    header.addEventListener('click', toggle);
    header.addEventListener('keydown', e => { if(['Enter',' '].includes(e.key)){ e.preventDefault(); toggle(); } });
  }

  function setupTabs(){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click', ()=> activateTab(tab.id));
      tab.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight' || e.key==='ArrowLeft'){
          e.preventDefault();
          const arr=[...tabs]; let idx = arr.indexOf(document.activeElement);
          idx = (e.key==='ArrowRight') ? (idx+1)%arr.length : (idx-1+arr.length)%arr.length;
          arr[idx].focus(); activateTab(arr[idx].id);
        }
      });
    });
  }

  function activateTab(tabId){
    document.querySelectorAll('.tab').forEach(tab=>{
      const isActive = (tab.id === tabId);
      tab.classList.toggle('active', isActive);
      tab.setAttribute('aria-selected', isActive);
      tab.setAttribute('tabindex', isActive ? '0' : '-1');
      const panel = document.getElementById(tab.getAttribute('aria-controls'));
      if(panel) panel.hidden = !isActive;
    });
    results.textContent='';
  }

  async function init(){
    MACHINES.forEach(machine=>{
      renderInputs(`constInputs-${machine}`, 'const', 'Calibration Constant', true, machine);
      renderInputs(`valueInputs-${machine}`, 'val', 'Laser', false, machine);
      for(let i=1;i<=NUM_FIELDS;i++){
        $(`#val${i}-${machine}`).addEventListener('input', () => checkCalculateButton(machine));
      }
      checkCalculateButton(machine);
      setupCollapsible(machine);
      loadConstants(machine);
    });

    setupTabs();

    // Deep-link via ?m=
    const m = getMachineFromUrl() || 'J95';
    activateTab(`tab-${m}`);
  }

  // expose for onclick
  window.calculate = calculate;
  window.saveConstants = saveConstants;

  init();
</script>

</body>
</html>
