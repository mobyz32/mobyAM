<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AM Machine Calculator</title>
  <style>
    :root{
      --primary:#F89728; --primary-hover:#d97f1f;
      --text:#111827; --label:#6B7280;
      --panel:#F3F4F6; --page:#FFFFFF;
      --ring: rgba(248,151,40,.45); --shadow: rgba(248,151,40,.35);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 420px; margin: 48px auto 120px; padding: 24px 16px 32px;  /* bottom space for numpad */
      background: var(--page); color: var(--text); line-height: 1.4; user-select:none;
    }
    h2{ font-weight:700; font-size:1.8rem; text-align:center; margin-bottom:1.5rem; color:var(--text); }
    .tabs{ display:flex; justify-content:center; margin-bottom:2rem; gap:16px; user-select:none; }
    .tab{
      padding:10px 20px; font-weight:600; font-size:1.05rem; border-radius:24px; border:2px solid transparent;
      cursor:pointer; color:var(--label); transition:all .25s ease; background:#fff; min-width:80px; text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .tab:hover{ color:var(--primary); border-color:var(--primary); }
    .tab.active{ color:#fff; background:var(--primary); border-color:var(--primary); box-shadow:0 6px 14px var(--shadow); cursor:default; }
    section{ margin-bottom:2rem; }
    h3,.collapsible-toggle{
      font-weight:600; font-size:1.05rem; margin-bottom:1rem; color:var(--text);
      border-bottom:1px solid #E5E7EB; padding-bottom:.35rem; cursor:pointer;
      user-select:none; display:flex; justify-content:space-between; align-items:center;
    }
    .input-group{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px 16px; }
    label{ display:block; font-weight:600; font-size:.85rem; color:var(--label); margin-bottom:4px; }
    input[type="text"]{
      width:100%; padding:10px 12px; font-size:1rem; border:1.5px solid #D1D5DB; border-radius:8px;
      transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
      background:var(--panel); color:var(--text);
    }
    input[type="text"]:focus{ outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px var(--ring); }
    button{
      width:100%; background:var(--primary); color:#fff; border:none; padding:14px 0; border-radius:10px;
      font-weight:700; font-size:1.05rem; cursor:pointer; transition:transform .06s ease, background .2s ease, box-shadow .2s ease;
      user-select:none; margin-top:1.2rem; box-shadow:0 8px 18px var(--shadow);
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ background:#FCD7AE; cursor:not-allowed; box-shadow:none; }
    button:not(:disabled):hover{ background:var(--primary-hover); box-shadow:0 10px 22px var(--shadow); }
    #results{
      padding:18px 20px; font-size:1.05rem; color:var(--text); background:#fff; border:1px solid #E5E7EB;
      border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,.05); min-height:68px; white-space:pre-wrap;
      font-family:'Segoe UI Mono', Consolas, monospace; user-select:text; transition:opacity .25s ease;
    }
    #results b{ color:var(--primary-hover); }
    .collapsed .arrow{ transform:rotate(-90deg); }
    .collapsible-content{ overflow:hidden; max-height:0; transition:max-height .3s ease, opacity .3s ease; pointer-events:none; opacity:0; user-select:none; }
    .collapsible-content.open{ max-height:600px; opacity:1; pointer-events:auto; user-select:auto; }
    .arrow{ transition:transform .3s ease; font-size:1.1rem; color:var(--label); }
    .subtle{ font-size:.82rem; color:var(--label); text-align:center; margin-top:.5rem; }

    /* Numpad */
    .numpad-wrap{
      position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #E5E7EB;
      box-shadow:0 -6px 16px rgba(0,0,0,.08); padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index:50;
    }
    .numpad-grid{
      max-width:420px; margin:0 auto; display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;
    }
    .key{
      padding:14px 0; text-align:center; font-size:1.15rem; font-weight:700; border-radius:10px; cursor:pointer; user-select:none;
      background:var(--panel); color:var(--text); border:1px solid #E5E7EB; transition:background .15s ease, transform .06s ease, box-shadow .2s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    .key:hover{ background:#fff; }
    .key:active{ transform: translateY(1px); }
    .key.primary{ background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 8px 18px var(--shadow); }
    .key.warn{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .key.wide{ grid-column: span 2; }
    .target-label{
      max-width:420px; margin:6px auto 10px; font-size:.9rem; color:var(--label); text-align:center;
    }
  </style>
</head>
<body>

<h2>AM Machine Calculator</h2>

<div class="tabs" role="tablist" aria-label="Select machine">
  <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="machine-J95" id="tab-J95">J95</div>
  <div class="tab" role="tab" tabindex="-1" aria-selected="false" aria-controls="machine-J149" id="tab-J149">J149</div>
</div>

<!-- J95 -->
<div id="machine-J95" role="tabpanel" aria-labelledby="tab-J95">
  <section aria-labelledby="lasers-header-J95">
    <h3 id="lasers-header-J95">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J95" role="group" aria-label="Laser input fields for J95"></div>
    <button id="calcBtn-J95" type="button" onclick="calculate('J95')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J95">
    <div class="collapsible-toggle collapsed" id="calibration-header-J95" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J95">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J95" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J95" role="group" aria-label="Calibration constants input fields for J95"></div>
      <button id="saveBtn-J95" type="button" onclick="saveConstants('J95')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J95" aria-live="polite"></div>
    </div>
  </section>
</div>

<!-- J149 -->
<div id="machine-J149" role="tabpanel" aria-labelledby="tab-J149" hidden>
  <section aria-labelledby="lasers-header-J149">
    <h3 id="lasers-header-J149">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J149" role="group" aria-label="Laser input fields for J149"></div>
    <button id="calcBtn-J149" type="button" onclick="calculate('J149')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J149">
    <div class="collapsible-toggle collapsed" id="calibration-header-J149" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J149">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J149" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J149" role="group" aria-label="Calibration constants input fields for J149"></div>
      <button id="saveBtn-J149" type="button" onclick="saveConstants('J149')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J149" aria-live="polite"></div>
    </div>
  </section>
</div>

<section aria-live="polite" aria-atomic="true" aria-relevant="additions">
  <div id="results" aria-label="Calculation results"></div>
</section>

<!-- Numpad -->
<div class="numpad-wrap" role="region" aria-label="Numeric keypad">
  <div class="target-label" id="numpadTarget">Tap a field to start typing…</div>
  <div class="numpad-grid">
    <div class="key" data-k="7">7</div>
    <div class="key" data-k="8">8</div>
    <div class="key" data-k="9">9</div>
    <div class="key" data-k="4">4</div>
    <div class="key" data-k="5">5</div>
    <div class="key" data-k="6">6</div>
    <div class="key" data-k="1">1</div>
    <div class="key" data-k="2">2</div>
    <div class="key" data-k="3">3</div>
    <div class="key" data-k="00">00</div>
    <div class="key" data-k="0">0</div>
    <div class="key warn" data-k="back">⌫</div>
    <div class="key wide" data-k="clear">Clear</div>
    <div class="key primary wide" data-k="enter">Done</div>
  </div>
</div>

<!-- Firebase + App (module) -->
<script type="module">
  /***** FIREBASE SETUP *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXwW14wEzGz5IjetGeWCb0tmU_lkDJqJI",
    authDomain: "mobyam32.firebaseapp.com",
    projectId: "mobyam32",
    storageBucket: "mobyam32.appspot.com",
    messagingSenderId: "453231570263",
    appId: "1:453231570263:web:1e219d402146960c502212"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /***** APP LOGIC *****/
  const NUM_FIELDS = 4;
  let currentMachine = 'J95';
  const results = document.getElementById('results');
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  function formatDate(d){ return `${String(d.getDate()).padStart(2,'0')} ${monthNames[d.getMonth()]} ${d.getFullYear()}`; }

  // === Bank-style formatting using an internal raw digits buffer ===
  let activeInput = null; // currently focused input element
  function setActiveInput(el){
    activeInput = el;
    document.getElementById('numpadTarget').textContent =
      `Typing into: ${el.getAttribute('id')}`;
    // ensure a buffer exists
    if (!el.dataset.digits) {
      const existingDigits = (el.value || '').replace(/\D/g,'');
      el.dataset.digits = existingDigits;
    }
  }
  function updateFromDigits(el){
    const digits = (el.dataset.digits || '').replace(/\D/g,'');
    if(!digits){ el.value=''; return; }
    el.value = (parseInt(digits,10)/100).toFixed(2);
    // trigger input event for validators
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }
  function attachBankFormatter(inputEl){
    // On focus, set active & select
    inputEl.addEventListener('focus', ()=>{
      // initialize buffer from current value
      inputEl.dataset.digits = (inputEl.value || '').replace(/\D/g,'');
      setActiveInput(inputEl);
      setTimeout(()=> inputEl.select(), 0);
    });
    // Handle manual typing: rebuild buffer from any keys the user enters
    inputEl.addEventListener('input', ()=>{
      inputEl.dataset.digits = (inputEl.value || '').replace(/\D/g,'');
      updateFromDigits(inputEl);
    });
  }

  // Create inputs (const & val)
  function createInputs(containerId, prefix, labelPrefix, loadSaved=false, machine=''){
    let html='';
    for(let i=1;i<=NUM_FIELDS;i++){
      let savedVal='';
      if(loadSaved && prefix==='const'){ savedVal = localStorage.getItem(machine+'_const'+i) || ''; }
      html += `
        <div>
          <label for="${prefix}${i}-${machine}">${labelPrefix} ${i}</label>
          <input type="text" inputmode="numeric" pattern="[0-9]*" id="${prefix}${i}-${machine}" placeholder="${labelPrefix} ${i}" value="${savedVal}" />
        </div>`;
    }
    document.getElementById(containerId).innerHTML = html;

    // attach formatter + focus tracking
    for(let i=1;i<=NUM_FIELDS;i++){
      const el = document.getElementById(`${prefix}${i}-${machine}`);
      attachBankFormatter(el);
      // click to set active even if it already has focus
      el.addEventListener('click', ()=> setActiveInput(el));
    }
  }

  // Save constants to localStorage & Firestore
  async function saveConstants(machine){
    let valid=true; const constants={};
    for(let i=1;i<=NUM_FIELDS;i++){
      const input = document.getElementById('const'+i+'-'+machine);
      if(!input.dataset.digits) input.dataset.digits = (input.value||'').replace(/\D/g,'');
      updateFromDigits(input); // normalize display
      if(input.value.trim()==='' || isNaN(parseFloat(input.value))){
        valid=false; input.style.borderColor='#ef4444';
      }else{
        input.style.borderColor='#D1D5DB';
        const val = parseFloat(input.value);
        localStorage.setItem(machine+'_const'+i, val.toFixed(2));
        constants['c'+i]=val;
      }
    }
    if(!valid){ alert('Please fill all constants with valid numbers.'); return; }

    const statusEl = document.getElementById('cloudStatus-'+machine);
    try{
      statusEl.textContent='Saving to cloud…';
      const nowIso = new Date().toISOString();
      await setDoc(doc(db,"constants",machine), { ...constants, lastUpdated: nowIso }, { merge:true });
      statusEl.textContent = `Updated ${formatDate(new Date(nowIso))}`;
    }catch(e){
      statusEl.textContent='Cloud save failed (using local values).';
      console.error(e);
    }

    const saveBtn = document.getElementById('saveBtn-'+machine);
    saveBtn.textContent='Saved ✓';
    setTimeout(()=> saveBtn.textContent='Save Constants', 1500);
    checkCalculateButton(machine);
  }

  // Load constants from Firestore → fall back to local
  async function loadConstants(machine){
    const statusEl = document.getElementById('cloudStatus-'+machine);
    try{
      statusEl.textContent='Loading from cloud…';
      const snap = await getDoc(doc(db,"constants",machine));
      if(snap.exists()){
        const data = snap.data();
        for(let i=1;i<=NUM_FIELDS;i++){
          const val = data['c'+i];
          if(typeof val==='number'){ localStorage.setItem(machine+'_const'+i, String(val.toFixed(2))); }
        }
        if(data.lastUpdated){
          statusEl.textContent = `Updated ${formatDate(new Date(data.lastUpdated))}`;
        }else{
          statusEl.textContent = `Updated ${formatDate(new Date())}`;
        }
      }else{
        statusEl.textContent='No cloud values yet (using local if any).';
      }
    }catch(e){
      statusEl.textContent='Cloud load failed (using local if any).';
      console.error(e);
    }
    // refresh constants UI and reattach formatters
    createInputs('constInputs-'+machine,'const','Calibration Constant',true,machine);
  }

  function checkCalculateButton(machine){
    let allFilled=true;
    for(let i=1;i<=NUM_FIELDS;i++){
      const input=document.getElementById('val'+i+'-'+machine);
      if(input.value.trim()==='' || isNaN(parseFloat(input.value))){
        allFilled=false; input.style.borderColor='#ef4444';
      }else{
        input.style.borderColor='#D1D5DB';
      }
    }
    document.getElementById('calcBtn-'+machine).disabled=!allFilled;
  }

  function calculate(machine){
    let output='';
    for(let i=1;i<=NUM_FIELDS;i++){
      const c=parseFloat(localStorage.getItem(machine+'_const'+i) || 0);
      const vEl=document.getElementById('val'+i+'-'+machine);
      if(!vEl.dataset.digits) vEl.dataset.digits=(vEl.value||'').replace(/\D/g,'');
      updateFromDigits(vEl);
      const v=parseFloat(vEl.value || 0);
      const diff=v-c;
      output += `${machine} Laser ${i}: <b>${diff.toFixed(2)}</b><br>\n`;
    }
    results.style.opacity=0;
    setTimeout(()=>{ results.innerHTML=output.trim(); results.style.opacity=1; },150);
  }

  function setupCollapsible(machine){
    const toggleHeader=document.getElementById('calibration-header-'+machine);
    const collapsibleContent=document.getElementById('constContent-'+machine);
    const arrow=toggleHeader.querySelector('.arrow');
    function toggleConstants(){
      const expanded=toggleHeader.getAttribute('aria-expanded')==='true';
      toggleHeader.setAttribute('aria-expanded', String(!expanded));
      collapsibleContent.classList.toggle('open');
      toggleHeader.classList.toggle('collapsed');
      arrow.textContent = expanded ? '▶' : '▼';
    }
    toggleHeader.addEventListener('click', toggleConstants);
    toggleHeader.addEventListener('keydown', e=>{
      if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleConstants(); }
    });
  }

  function setupTabs(){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{ activateTab(tab.id); });
      tab.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight'||e.key==='ArrowLeft'){
          e.preventDefault();
          let index=Array.from(tabs).indexOf(document.activeElement);
          index = (e.key==='ArrowRight') ? (index+1)%tabs.length : (index-1+tabs.length)%tabs.length;
          tabs[index].focus(); activateTab(tabs[index].id);
        }
      });
    });
  }
  function activateTab(tabId){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const isActive=(tab.id===tabId);
      tab.classList.toggle('active', isActive);
      tab.setAttribute('aria-selected', isActive);
      tab.setAttribute('tabindex', isActive ? '0' : '-1');
      const panelId=tab.getAttribute('aria-controls');
      const panel=document.getElementById(panelId);
      if(panel) panel.hidden=!isActive;
    });
    currentMachine = tabId.replace('tab-','');
    results.textContent='';
  }

  async function init(){
    ['J95','J149'].forEach(machine=>{
      createInputs('constInputs-'+machine,'const','Calibration Constant',true,machine);
      createInputs('valueInputs-'+machine,'val','Laser',false,machine);

      for(let i=1;i<=NUM_FIELDS;i++){
        const valEl=document.getElementById('val'+i+'-'+machine);
        valEl.addEventListener('input', ()=> checkCalculateButton(machine));
        // auto-select a sensible first active input
        if(i===1 && machine==='J95'){ setActiveInput(valEl); }
      }
      checkCalculateButton(machine);
      setupCollapsible(machine);
      loadConstants(machine);
    });
    setupTabs();

    // numpad handlers
    document.querySelectorAll('.key').forEach(k=>{
      k.addEventListener('click', ()=>{
        if(!activeInput) return;
        // ensure buffer exists
        if (!activeInput.dataset.digits) activeInput.dataset.digits = (activeInput.value||'').replace(/\D/g,'');
        const action = k.dataset.k;
        if(action==='back'){
          activeInput.dataset.digits = activeInput.dataset.digits.slice(0,-1);
        }else if(action==='clear'){
          activeInput.dataset.digits = '';
        }else if(action==='enter'){
          // move focus to next input if exists
          const inputs = Array.from(document.querySelectorAll('input[type="text"]'))
            .filter(el => el.id.startsWith('val') && !el.closest('[hidden]')); // current tab's lasers
          const idx = inputs.indexOf(activeInput);
          if(idx>=0 && idx<inputs.length-1){
            inputs[idx+1].focus();
            setActiveInput(inputs[idx+1]);
          }else{
            // no next laser: try constants first field in current machine
            const constFirst = document.getElementById('const1-'+currentMachine);
            if(constFirst){ constFirst.focus(); setActiveInput(constFirst); }
          }
        }else{
          // digit or "00"
          // cap buffer length to avoid overflow (e.g., 12 digits -> max 99999999.99)
          const maxDigits = 10;
          let add = action === '00' ? '00' : action;
          const newLen = (activeInput.dataset.digits.length + add.length);
          if(newLen <= maxDigits){
            activeInput.dataset.digits += add;
          }
        }
        updateFromDigits(activeInput);
      });
    });
  }

  window.calculate = calculate;
  window.saveConstants = saveConstants;

  init();
</script>

</body>
</html>