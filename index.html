<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AM Machine Calculator</title>
  <style>
    :root{
      --primary:#F89728; --primary-hover:#d97f1f;
      --text:#111827; --label:#6B7280;
      --panel:#F3F4F6; --page:#FFFFFF;
      --ring: rgba(248,151,40,.45); --shadow: rgba(248,151,40,.35);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width:420px; margin:48px auto; padding:24px 16px 32px;
      background:var(--page); color:var(--text); line-height:1.4; user-select:none;
    }
    h2{ font-weight:700; font-size:1.8rem; text-align:center; margin-bottom:1.5rem; color:var(--text); }
    .tabs{ display:flex; justify-content:center; margin-bottom:2rem; gap:16px; user-select:none; }
    .tab{
      padding:10px 20px; font-weight:600; font-size:1.05rem; border-radius:24px; border:2px solid transparent;
      cursor:pointer; color:var(--label); transition:all .25s ease; background:#fff; min-width:80px; text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .tab:hover{ color:var(--primary); border-color:var(--primary); }
    .tab.active{ color:#fff; background:var(--primary); border-color:var(--primary); box-shadow:0 6px 14px var(--shadow); cursor:default; }
    section{ margin-bottom:2rem; }
    h3,.collapsible-toggle{
      font-weight:600; font-size:1.05rem; margin-bottom:1rem; color:var(--text);
      border-bottom:1px solid #E5E7EB; padding-bottom:.35rem; cursor:pointer;
      user-select:none; display:flex; justify-content:space-between; align-items:center;
    }
    .input-group{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px 16px; }
    label{ display:block; font-weight:600; font-size:.85rem; color:var(--label); margin-bottom:4px; }
    .field-row{ display:flex; align-items:center; gap:8px; }
    input[type="text"]{
      width:100%; padding:10px 12px; font-size:1rem; border:1.5px solid #D1D5DB; border-radius:8px;
      transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
      background:var(--panel); color:var(--text);
    }
    input[type="text"]:focus{
      outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px var(--ring);
    }
    /* small 00 chip */
    .chip{
      flex:0 0 auto; padding:8px 10px; border-radius:8px; font-weight:700; font-size:.95rem; line-height:1;
      color:var(--primary); background:#fff; border:2px solid var(--primary); cursor:pointer; user-select:none;
      transition:background .15s ease, color .15s ease, box-shadow .2s ease, transform .06s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .chip:hover{ background:#FFF7EE; }
    .chip:active{ transform:translateY(1px); }
    button{
      width:100%; background:var(--primary); color:#fff; border:none; padding:14px 0; border-radius:10px;
      font-weight:700; font-size:1.05rem; cursor:pointer; transition:transform .06s ease, background .2s ease, box-shadow .2s ease;
      user-select:none; margin-top:1.2rem; box-shadow:0 8px 18px var(--shadow);
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ background:#FCD7AE; cursor:not-allowed; box-shadow:none; }
    button:not(:disabled):hover{ background:var(--primary-hover); box-shadow:0 10px 22px var(--shadow); }
    #results{
      padding:18px 20px; font-size:1.05rem; color:var(--text); background:#fff; border:1px solid #E5E7EB;
      border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,.05); min-height:68px; white-space:pre-wrap;
      font-family:'Segoe UI Mono', Consolas, monospace; user-select:text; transition:opacity .25s ease;
    }
    #results b{ color:var(--primary-hover); }
    .collapsed .arrow{ transform:rotate(-90deg); }
    .collapsible-content{ overflow:hidden; max-height:0; transition:max-height .3s ease, opacity .3s ease; pointer-events:none; opacity:0; user-select:none; }
    .collapsible-content.open{ max-height:600px; opacity:1; pointer-events:auto; user-select:auto; }
    .arrow{ transition:transform .3s ease; font-size:1.1rem; color:var(--label); }
    .subtle{ font-size:.82rem; color:var(--label); text-align:center; margin-top:.5rem; }
  </style>
</head>
<body>

<h2>AM Machine Calculator</h2>

<div class="tabs" role="tablist" aria-label="Select machine">
  <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="machine-J95" id="tab-J95">J95</div>
  <div class="tab" role="tab" tabindex="-1" aria-selected="false" aria-controls="machine-J149" id="tab-J149">J149</div>
</div>

<!-- J95 -->
<div id="machine-J95" role="tabpanel" aria-labelledby="tab-J95">
  <section aria-labelledby="lasers-header-J95">
    <h3 id="lasers-header-J95">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J95" role="group" aria-label="Laser input fields for J95"></div>
    <button id="calcBtn-J95" type="button" onclick="calculate('J95')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J95">
    <div class="collapsible-toggle collapsed" id="calibration-header-J95" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J95">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J95" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J95" role="group" aria-label="Calibration constants input fields for J95"></div>
      <button id="saveBtn-J95" type="button" onclick="saveConstants('J95')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J95" aria-live="polite"></div>
    </div>
  </section>
</div>

<!-- J149 -->
<div id="machine-J149" role="tabpanel" aria-labelledby="tab-J149" hidden>
  <section aria-labelledby="lasers-header-J149">
    <h3 id="lasers-header-J149">Enter Laser Values</h3>
    <div class="input-group" id="valueInputs-J149" role="group" aria-label="Laser input fields for J149"></div>
    <button id="calcBtn-J149" type="button" onclick="calculate('J149')" disabled>Calculate</button>
  </section>
  <section aria-labelledby="calibration-header-J149">
    <div class="collapsible-toggle collapsed" id="calibration-header-J149" tabindex="0" role="button" aria-expanded="false" aria-controls="constContent-J149">
      Calibration Constants <span class="arrow">▶</span>
    </div>
    <div id="constContent-J149" class="collapsible-content" role="region" aria-hidden="true">
      <div class="input-group" id="constInputs-J149" role="group" aria-label="Calibration constants input fields for J149"></div>
      <button id="saveBtn-J149" type="button" onclick="saveConstants('J149')">Save Constants</button>
      <div class="subtle" id="cloudStatus-J149" aria-live="polite"></div>
    </div>
  </section>
</div>

<section aria-live="polite" aria-atomic="true" aria-relevant="additions">
  <div id="results" aria-label="Calculation results"></div>
</section>

<!-- Firebase + App (module) -->
<script type="module">
  /***** FIREBASE SETUP *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXwW14wEzGz5IjetGeWCb0tmU_lkDJqJI",
    authDomain: "mobyam32.firebaseapp.com",
    projectId: "mobyam32",
    storageBucket: "mobyam32.appspot.com",
    messagingSenderId: "453231570263",
    appId: "1:453231570263:web:1e219d402146960c502212"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /***** APP LOGIC *****/
  const NUM_FIELDS = 4;
  const MAX_DIGITS = 10; // safety cap for raw digits buffer
  let currentMachine = 'J95';
  const results = document.getElementById('results');

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  function formatDate(d){ return `${String(d.getDate()).padStart(2,'0')} ${monthNames[d.getMonth()]} ${d.getFullYear()}`; }

  // Keep a raw digits buffer per input for bank-style formatting
  function setActiveBuffer(el){
    if (!el.dataset.digits) {
      el.dataset.digits = (el.value || '').replace(/\D/g,'');
    }
  }
  function updateFromDigits(el){
    const digits = (el.dataset.digits || '').replace(/\D/g,'');
    if(!digits){ el.value=''; return; }
    el.value = (parseInt(digits,10)/100).toFixed(2);
    // trigger input event for validators
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }
  // Bank-style formatter: last two digits are decimals
  function attachBankFormatter(inputEl){
    inputEl.addEventListener('focus', ()=> {
      setActiveBuffer(inputEl);
      setTimeout(()=> inputEl.select(), 0);
    });
    inputEl.addEventListener('input', ()=>{
      inputEl.dataset.digits = (inputEl.value || '').replace(/\D/g,'');
      updateFromDigits(inputEl);
    });
  }

  // Create inputs (const & val) with inline "00" chip
  function createInputs(containerId, prefix, labelPrefix, loadSaved=false, machine=''){
    let html='';
    for(let i=1;i<=NUM_FIELDS;i++){
      let savedVal='';
      if(loadSaved && prefix==='const'){ savedVal = localStorage.getItem(machine+'_const'+i) || ''; }
      const id = `${prefix}${i}-${machine}`;
      html += `
        <div>
          <label for="${id}">${labelPrefix} ${i}</label>
          <div class="field-row">
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="${id}" placeholder="${labelPrefix} ${i}" value="${savedVal}" />
            <button type="button" class="chip" data-target="${id}" aria-label="Insert double zero into ${labelPrefix} ${i}">00</button>
          </div>
        </div>`;
    }
    document.getElementById(containerId).innerHTML = html;

    // attach formatter + chip handlers
    for(let i=1;i<=NUM_FIELDS;i++){
      const id = `${prefix}${i}-${machine}`;
      const el = document.getElementById(id);
      const chip = document.querySelector(`.chip[data-target="${id}"]`);
      attachBankFormatter(el);
      el.addEventListener('click', ()=> setActiveBuffer(el));

      chip.addEventListener('click', ()=>{
        setActiveBuffer(el);
        const cur = el.dataset.digits || '';
        if (cur.length + 2 <= MAX_DIGITS){
          el.dataset.digits = cur + '00';
          updateFromDigits(el);
        }
        el.focus();
      });
    }
  }

  // Save constants to localStorage & Firestore
  async function saveConstants(machine){
    let valid=true; const constants={};
    for(let i=1;i<=NUM_FIELDS;i++){
      const input = document.getElementById('const'+i+'-'+machine);
      setActiveBuffer(input); updateFromDigits(input); // normalize
      if(input.value.trim()==='' || isNaN(parseFloat(input.value))){
        valid=false; input.style.borderColor='#ef4444';
      }else{
        input.style.borderColor='#D1D5DB';
        const val = parseFloat(input.value);
        localStorage.setItem(machine+'_const'+i, val.toFixed(2));
        constants['c'+i]=val;
      }
    }
    if(!valid){ alert('Please fill all constants with valid numbers.'); return; }

    const statusEl = document.getElementById('cloudStatus-'+machine);
    try{
      statusEl.textContent='Saving to cloud…';
      const nowIso = new Date().toISOString();
      await setDoc(doc(db,"constants",machine), { ...constants, lastUpdated: nowIso }, { merge:true });
      statusEl.textContent = `Updated ${formatDate(new Date(nowIso))}`;
    }catch(e){
      statusEl.textContent='Cloud save failed (using local values).';
      console.error(e);
    }

    const saveBtn = document.getElementById('saveBtn-'+machine);
    saveBtn.textContent='Saved ✓';
    setTimeout(()=> saveBtn.textContent='Save Constants', 1500);
    checkCalculateButton(machine);
  }

  // Load constants from Firestore → fall back to local
  async function loadConstants(machine){
    const statusEl = document.getElementById('cloudStatus-'+machine);
    try{
      statusEl.textContent='Loading from cloud…';
      const snap = await getDoc(doc(db,"constants",machine));
      if(snap.exists()){
        const data = snap.data();
        for(let i=1;i<=NUM_FIELDS;i++){
          const val = data['c'+i];
          if(typeof val==='number'){ localStorage.setItem(machine+'_const'+i, String(val.toFixed(2))); }
        }
        if(data.lastUpdated){
          statusEl.textContent = `Updated ${formatDate(new Date(data.lastUpdated))}`;
        }else{
          statusEl.textContent = `Updated ${formatDate(new Date())}`;
        }
      }else{
        statusEl.textContent='No cloud values yet (using local if any).';
      }
    }catch(e){
      statusEl.textContent='Cloud load failed (using local if any).';
      console.error(e);
    }
    // refresh constants UI and reattach formatters/chips
    createInputs('constInputs-'+machine,'const','Calibration Constant',true,machine);
  }

  function checkCalculateButton(machine){
    let allFilled=true;
    for(let i=1;i<=NUM_FIELDS;i++){
      const input=document.getElementById('val'+i+'-'+machine);
      if(input.value.trim()==='' || isNaN(parseFloat(input.value))){
        allFilled=false; input.style.borderColor='#ef4444';
      }else{
        input.style.borderColor='#D1D5DB';
      }
    }
    document.getElementById('calcBtn-'+machine).disabled=!allFilled;
  }

  function calculate(machine){
    let output='';
    for(let i=1;i<=NUM_FIELDS;i++){
      const c=parseFloat(localStorage.getItem(machine+'_const'+i) || 0);
      const vEl=document.getElementById('val'+i+'-'+machine);
      setActiveBuffer(vEl); updateFromDigits(vEl); // normalize
      const v=parseFloat(vEl.value || 0);
      const diff=v-c;
      output += `${machine} Laser ${i}: <b>${diff.toFixed(2)}</b><br>\n`;
    }
    results.style.opacity=0;
    setTimeout(()=>{ results.innerHTML=output.trim(); results.style.opacity=1; },150);
  }

  function setupCollapsible(machine){
    const toggleHeader=document.getElementById('calibration-header-'+machine);
    const collapsibleContent=document.getElementById('constContent-'+machine);
    const arrow=toggleHeader.querySelector('.arrow');
    function toggleConstants(){
      const expanded=toggleHeader.getAttribute('aria-expanded')==='true';
      toggleHeader.setAttribute('aria-expanded', String(!expanded));
      collapsibleContent.classList.toggle('open');
      toggleHeader.classList.toggle('collapsed');
      arrow.textContent = expanded ? '▶' : '▼';
    }
    toggleHeader.addEventListener('click', toggleConstants);
    toggleHeader.addEventListener('keydown', e=>{
      if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleConstants(); }
    });
  }

  function setupTabs(){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{ activateTab(tab.id); });
      tab.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight'||e.key==='ArrowLeft'){
          e.preventDefault();
          let index=Array.from(tabs).indexOf(document.activeElement);
          index = (e.key==='ArrowRight') ? (index+1)%tabs.length : (index-1+tabs.length)%tabs.length;
          tabs[index].focus(); activateTab(tabs[index].id);
        }
      });
    });
  }
  function activateTab(tabId){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const isActive=(tab.id===tabId);
      tab.classList.toggle('active', isActive);
      tab.setAttribute('aria-selected', isActive);
      tab.setAttribute('tabindex', isActive ? '0' : '-1');
      const panelId=tab.getAttribute('aria-controls');
      const panel=document.getElementById(panelId);
      if(panel) panel.hidden=!isActive;
    });
    currentMachine = tabId.replace('tab-','');
    results.textContent='';
  }

  async function init(){
    ['J95','J149'].forEach(machine=>{
      createInputs('constInputs-'+machine,'const','Calibration Constant',true,machine);
      createInputs('valueInputs-'+machine,'val','Laser',false,machine);

      for(let i=1;i<=NUM_FIELDS;i++){
        const valEl=document.getElementById('val'+i+'-'+machine);
        valEl.addEventListener('input', ()=> checkCalculateButton(machine));
      }
      checkCalculateButton(machine);
      setupCollapsible(machine);
      loadConstants(machine);
    });
    setupTabs();
  }

  window.calculate = calculate;
  window.saveConstants = saveConstants;

  init();
</script>

</body>
</html>